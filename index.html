<!DOCTYPE html>
<html>
<style type='text/css'>
  canvas {
    border: 1px solid magenta;
  }
</style>
<script type="text/javascript" src="ComplexNumber.js"></script>
<script type="text/javascript" src="ComplexPolynomial.js"></script>
<body></body>
<script type='text/javascript'>

function complexNewtonStep(polynomial, guess) {
  const px = polynomial.valueAt(guess);
  const pprimex = polynomial.derivativeAt(guess);
  return guess.add(px.divide(pprimex).multiply(-1));
}

function complexFindZero(polynomial, guess, max_steps, tolerance) {
  let value = polynomial.valueAt(guess);
  let num_steps = 0;
  while (value.lengthSq() > tolerance) {
    const new_guess = complexNewtonStep(polynomial, guess);
    guess = new_guess;
    value = polynomial.valueAt(guess);
    num_steps += 1;
    if (num_steps === max_steps)
      break;
  }

  return guess;
}

function findClosestZero(value, roots) {
  let minDist = 1e999;
  let minRoot = null;
  for (i in roots) {
    const r = roots[i];
    const dist = (r.real - value.real) ** 2 + (r.imaginary - value.imaginary) ** 2;
    if (dist < minDist) {
      minDist = dist;
      minRoot = i;
    }
  }
  return minRoot;
}
const S = 500;
const POINT_SIZE = 5;
const PIXEL_SIZE = 10;
const MAX_STEPS = 5;
const COLORS = ["#e439a1", "#38b5ce", "#886ed6"];
const COORDINATE_SIZE = 20;
const ROOT_NUMBERS = [
  [0, 0],
  [-10, 5],
  [10, -5],
];

const rootRatio = S / COORDINATE_SIZE / 2;
const ROOTS = [
  new ComplexNumber(ROOT_NUMBERS[0][0] * rootRatio, ROOT_NUMBERS[0][1] * rootRatio),
  new ComplexNumber(ROOT_NUMBERS[1][0] * rootRatio, ROOT_NUMBERS[1][1] * rootRatio),
  new ComplexNumber(ROOT_NUMBERS[2][0] * rootRatio, ROOT_NUMBERS[2][1] * rootRatio),
];


const canvas = document.createElement('canvas');
document.body.appendChild(canvas);
const ctx = canvas.getContext('2d');
canvas.width = canvas.height = S;

function draw() {
  const func = new ComplexPolynomial(ROOTS);
  ctx.reset();
  ctx.translate(S/2, S/2);
  const dim = S;
  for (var x = -dim/2; x < dim/2; x+=PIXEL_SIZE) {
    for (var y = -dim/2; y < dim/2; y+=PIXEL_SIZE) {
      const zero = complexFindZero(func, new ComplexNumber(x, y), MAX_STEPS, .10);
      const numRoot = findClosestZero(zero, ROOTS);
      ctx.beginPath();
      ctx.fillStyle = COLORS[numRoot];
      ctx.fillRect(x, y, PIXEL_SIZE * .9, PIXEL_SIZE * .9);
      ctx.fill();
    }
  }

  ctx.fillStyle = "black";
  for (r of ROOTS) {
    ctx.beginPath();
    ctx.arc(r.real, r.imaginary, POINT_SIZE, 0, 2*Math.PI);
    ctx.fill();
  }

  ctx.translate(-S/2, -S/2);
  ctx.moveTo(0, S/2);
  ctx.lineTo(S, S/2);
  ctx.moveTo(S/2, 0);
  ctx.lineTo(S/2, S);
  ctx.stroke();
}
draw();

var mouseDown = 0;
document.body.onmousedown = function() {
  ++mouseDown;
}
document.body.onmouseup = function() {
  --mouseDown;
}

canvas.addEventListener('mousemove', e => {
  if (mouseDown) {
    x = e.offsetX - 0.5 * S;
    y = e.offsetY - 0.5 * S;
    const pt = new ComplexNumber(x, y);
    const num = findClosestZero(pt, ROOTS);
    ROOTS[num] = pt;
    draw();
  }
});


</script>
</html>
